<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test VK Video</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .video-container {
      position: relative;
      padding-bottom: 56.25%;
      height: 0;
      overflow: hidden;
      background: #000;
      margin: 10px 0;
    }
    .video-container iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    pre {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
    }
    .success { color: #27ae60; font-weight: bold; }
    .error { color: #e74c3c; font-weight: bold; }
    .warning { color: #f39c12; font-weight: bold; }
    textarea {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      font-family: monospace;
      font-size: 12px;
      border: 2px solid #ddd;
      border-radius: 4px;
    }
    button {
      padding: 12px 24px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
    }
    button:hover {
      background: #2980b9;
    }
    .info-box {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      padding: 12px;
      margin: 10px 0;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <h1>üé• Test VK Video Integration</h1>

  <div class="test-section">
    <h2>1. Test URL Parser</h2>
    <p>Paste VK video URL or entire iframe code below:</p>
    <textarea id="test-url" rows="4" placeholder="Paste VK video URL or iframe code here...">https://vkvideo.ru/video_ext.php?oid=-157301945&id=456239025&hash=0998d1d02641da56</textarea>
    <button onclick="testParser()">Parse & Test Video</button>
    <div id="parse-result"></div>
  </div>

  <div class="test-section">
    <h2>2. Video Playback Test</h2>
    <div id="video-test"></div>
  </div>

  <div class="test-section">
    <h2>3. Examples to Try</h2>
    <div class="info-box">
      <p><strong>Example 1 - Direct embed URL:</strong></p>
      <pre>https://vkvideo.ru/video_ext.php?oid=-157301945&id=456239025&hash=0998d1d02641da56</pre>
      <button onclick="testExample('https://vkvideo.ru/video_ext.php?oid=-157301945&id=456239025&hash=0998d1d02641da56')">Test This</button>
    </div>
    <div class="info-box">
      <p><strong>Example 2 - Full iframe code:</strong></p>
      <pre>&lt;iframe src="https://vkvideo.ru/video_ext.php?oid=-157301945&id=456239025&hash=0998d1d02641da56" width="640" height="360" frameborder="0" allowfullscreen="1"&gt;&lt;/iframe&gt;</pre>
      <button onclick="testExample('<iframe src=&quot;https://vkvideo.ru/video_ext.php?oid=-157301945&id=456239025&hash=0998d1d02641da56&quot; width=&quot;640&quot; height=&quot;360&quot; frameborder=&quot;0&quot; allowfullscreen=&quot;1&quot;></iframe>')">Test This</button>
    </div>
  </div>

  <div class="test-section">
    <h2>4. Database Videos</h2>
    <button onclick="loadDatabaseData()">Load Videos from Database</button>
    <div id="db-output"></div>
  </div>

  <script type="module">
    import { api } from './lib/api.js';

    // Copy parsing functions from main.js
    function extractVkEmbedUrl(input) {
      if (!input) return null;
      input = input.trim();
      if (input.includes('<iframe')) {
        const srcMatch = input.match(/src=["']([^"']+)["']/i);
        if (srcMatch) {
          console.log('[VK Video] Extracted src from iframe:', srcMatch[1]);
          return srcMatch[1];
        }
      }
      return input;
    }

    function parseVkVideoUrl(url) {
      if (!url) return null;
      url = extractVkEmbedUrl(url);
      if (!url) return null;
      url = url.trim();
      if (!url.startsWith('http')) {
        url = 'https://' + url;
      }
      if (!url.includes('video_ext.php')) {
        console.error('[VK Video] Invalid format. URL must contain video_ext.php');
        return null;
      }
      try {
        const urlObj = new URL(url);
        const oid = urlObj.searchParams.get('oid');
        const id = urlObj.searchParams.get('id');
        const hash = urlObj.searchParams.get('hash');
        if (!oid || !id) {
          console.error('[VK Video] Missing required parameters (oid or id)');
          return null;
        }
        if (!hash) {
          console.warn('[VK Video] Missing hash parameter - video may not work');
        }
        let hd = urlObj.searchParams.get('hd');
        if (!hd) {
          urlObj.searchParams.set('hd', '2');
        }
        const finalUrl = urlObj.toString();
        console.log('[VK Video] Embed URL ready:', finalUrl);
        return finalUrl;
      } catch (e) {
        console.error('[VK Video] Error parsing URL:', e);
        return null;
      }
    }

    window.testParser = function() {
      const input = document.getElementById('test-url').value;
      const result = document.getElementById('parse-result');
      const videoTest = document.getElementById('video-test');

      console.clear();
      console.log('Testing URL:', input);

      const embedUrl = parseVkVideoUrl(input);

      if (embedUrl) {
        result.innerHTML = `
          <div style="margin-top: 15px;">
            <p class="success">‚úÖ Successfully parsed!</p>
            <p><strong>Final Embed URL:</strong></p>
            <pre>${embedUrl}</pre>
          </div>
        `;

        videoTest.innerHTML = `
          <p><strong>Video should appear below:</strong></p>
          <div class="video-container">
            <iframe
              src="${embedUrl}"
              frameborder="0"
              allowfullscreen="1"
              allow="autoplay; encrypted-media; fullscreen; picture-in-picture"
            ></iframe>
          </div>
          <p style="margin-top: 10px; color: #666; font-size: 14px;">
            If you see a black screen, the video may be private or the hash parameter is invalid.
          </p>
        `;
      } else {
        result.innerHTML = `<p class="error" style="margin-top: 15px;">‚ùå Failed to parse URL. Check console for details.</p>`;
        videoTest.innerHTML = '';
      }
    };

    window.testExample = function(exampleUrl) {
      document.getElementById('test-url').value = exampleUrl;
      window.testParser();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    window.loadDatabaseData = async function() {
      const output = document.getElementById('db-output');
      output.innerHTML = '<p>Loading...</p>';

      try {
        const teachers = await api.getTeachers();
        const reviews = await api.getReviews();

        if (teachers.length === 0 && reviews.length === 0) {
          output.innerHTML = '<p class="warning">‚ö†Ô∏è No videos found in database. Add some in the admin panel!</p>';
          return;
        }

        output.innerHTML = `
          <h3>Teachers (${teachers.length})</h3>
          ${teachers.map(t => {
            const embedUrl = parseVkVideoUrl(t.video_url);
            return `
              <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 4px;">
                <h4>${t.name}</h4>
                <p><strong>Video URL:</strong></p>
                <pre>${t.video_url}</pre>
                <p><strong>Platform:</strong> ${t.video_platform}</p>
                ${embedUrl ? `
                  <p class="success">‚úÖ URL parsed successfully</p>
                  <div class="video-container">
                    <iframe
                      src="${embedUrl}"
                      frameborder="0"
                      allowfullscreen="1"
                      allow="autoplay; encrypted-media; fullscreen; picture-in-picture"
                    ></iframe>
                  </div>
                ` : '<p class="error">‚ùå Failed to parse URL</p>'}
              </div>
            `;
          }).join('')}

          <h3>Reviews (${reviews.length})</h3>
          ${reviews.map(r => {
            const embedUrl = parseVkVideoUrl(r.video_url);
            return `
              <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 4px;">
                <p><strong>Video URL:</strong></p>
                <pre>${r.video_url}</pre>
                <p><strong>Platform:</strong> ${r.video_platform}</p>
                ${embedUrl ? `
                  <p class="success">‚úÖ URL parsed successfully</p>
                  <div class="video-container">
                    <iframe
                      src="${embedUrl}"
                      frameborder="0"
                      allowfullscreen="1"
                      allow="autoplay; encrypted-media; fullscreen; picture-in-picture"
                    ></iframe>
                  </div>
                ` : '<p class="error">‚ùå Failed to parse URL</p>'}
              </div>
            `;
          }).join('')}
        `;
      } catch (error) {
        console.error('Error:', error);
        output.innerHTML = `<p class="error">‚ùå Error loading data: ${error.message}</p>`;
      }
    };

    // Auto-test with default URL on page load
    window.testParser();
  </script>
</body>
</html>
